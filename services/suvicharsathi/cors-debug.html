<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Debug Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-3">
        <h2>üîç CORS Debug Test</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Current Configuration</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Frontend URL:</strong> <span id="frontendUrl" class="text-primary"></span></p>
                        <p><strong>Backend URL:</strong> <span class="text-info">https://cuddly-spork-xqvpg9w4xh6pxr-8000.app.github.dev</span></p>
                        <p><strong>Backend CORS Enabled For:</strong> <span class="text-success">127.0.0.1:5500</span></p>
                        
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Common Issue:</strong> Your backend allows <code>127.0.0.1:5500</code> but your browser might be using <code>localhost:5500</code>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button id="testBasic" class="btn btn-primary btn-sm mb-2 w-100">1. Test Basic Connection</button>
                        <button id="testPreflight" class="btn btn-warning btn-sm mb-2 w-100">2. Test CORS Preflight</button>
                        <button id="testOTP" class="btn btn-success btn-sm mb-2 w-100">3. Test OTP Endpoint</button>
                        <button id="testFromBoth" class="btn btn-info btn-sm mb-2 w-100">4. Test Both URLs</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Results</h5>
                        <button id="clearResults" class="btn btn-sm btn-outline-secondary float-end">Clear</button>
                    </div>
                    <div class="card-body">
                        <div id="results" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script>
        const api = new APIService();
        const resultsDiv = document.getElementById('results');
        
        // Display current frontend URL
        document.getElementById('frontendUrl').textContent = window.location.origin;

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const colors = {
                'success': 'color: green;',
                'error': 'color: red;',
                'warning': 'color: orange;',
                'info': 'color: blue;'
            };
            
            const div = document.createElement('div');
            div.innerHTML = `<span style="color: gray;">[${time}]</span> <span style="${colors[type] || ''}">${message}</span>`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function separator() {
            log('‚ïê'.repeat(50), 'info');
        }

        // Test 1: Basic Connection
        document.getElementById('testBasic').addEventListener('click', async () => {
            separator();
            log('üîç TEST 1: Basic Backend Connection', 'info');
            log(`Frontend Origin: ${window.location.origin}`, 'info');
            
            try {
                const response = await fetch(api.baseURL, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log(`‚úÖ Connection Success! Status: ${response.status}`, 'success');
                
                // Check CORS headers
                const corsOrigin = response.headers.get('access-control-allow-origin');
                if (corsOrigin) {
                    log(`‚úÖ CORS Origin Header: ${corsOrigin}`, 'success');
                    if (corsOrigin === window.location.origin || corsOrigin === '*') {
                        log('‚úÖ CORS Origin matches our frontend!', 'success');
                    } else {
                        log('‚ùå CORS Origin does NOT match our frontend!', 'error');
                        log(`Expected: ${window.location.origin}, Got: ${corsOrigin}`, 'error');
                    }
                } else {
                    log('‚ùå No CORS Origin header found', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Connection Failed: ${error.message}`, 'error');
                if (error.message.includes('CORS')) {
                    log('üö® This is a CORS policy error!', 'error');
                }
            }
        });

        // Test 2: CORS Preflight
        document.getElementById('testPreflight').addEventListener('click', async () => {
            separator();
            log('üîç TEST 2: CORS Preflight Request', 'info');
            
            try {
                const response = await fetch(`${api.baseURL}/auth/register/send-otp`, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'content-type',
                        'Origin': window.location.origin
                    }
                });
                
                log(`‚úÖ Preflight Success! Status: ${response.status}`, 'success');
                
                const allowMethods = response.headers.get('access-control-allow-methods');
                const allowHeaders = response.headers.get('access-control-allow-headers');
                const allowOrigin = response.headers.get('access-control-allow-origin');
                
                log(`Allow-Methods: ${allowMethods || 'Not set'}`, allowMethods ? 'success' : 'warning');
                log(`Allow-Headers: ${allowHeaders || 'Not set'}`, allowHeaders ? 'success' : 'warning');
                log(`Allow-Origin: ${allowOrigin || 'Not set'}`, allowOrigin ? 'success' : 'warning');
                
            } catch (error) {
                log(`‚ùå Preflight Failed: ${error.message}`, 'error');
            }
        });

        // Test 3: OTP Endpoint
        document.getElementById('testOTP').addEventListener('click', async () => {
            separator();
            log('üîç TEST 3: OTP Endpoint Test', 'info');
            
            try {
                const response = await fetch(`${api.baseURL}/auth/register/send-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: '+919999999999',
                        full_name: 'Test User',
                        email: 'test@example.com'
                    })
                });

                log(`Response Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'warning');
                
                let data;
                try {
                    data = await response.json();
                    log(`Response Data: ${JSON.stringify(data, null, 2)}`, 'info');
                } catch (e) {
                    const text = await response.text();
                    log(`Response Text: ${text}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå OTP Test Failed: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    log('üîß CORS Fix Needed: Add your origin to backend CORS config', 'warning');
                    log(`Your Origin: ${window.location.origin}`, 'warning');
                }
            }
        });

        // Test 4: Test both localhost and 127.0.0.1
        document.getElementById('testFromBoth').addEventListener('click', async () => {
            separator();
            log('üîç TEST 4: URL Comparison Test', 'info');
            
            const currentOrigin = window.location.origin;
            log(`Current URL: ${currentOrigin}`, 'info');
            
            // Check if we're on localhost vs 127.0.0.1
            if (currentOrigin.includes('localhost')) {
                log('üî∏ You are using localhost - backend expects 127.0.0.1', 'warning');
                log('üîß Solution: Change backend CORS to allow both:', 'info');
                log('   - http://localhost:5500', 'info');
                log('   - http://127.0.0.1:5500', 'info');
                log('Or access frontend via: http://127.0.0.1:5500', 'info');
            } else if (currentOrigin.includes('127.0.0.1')) {
                log('‚úÖ You are using 127.0.0.1 - matches backend config', 'success');
            } else {
                log(`üî∏ You are using: ${currentOrigin}`, 'warning');
                log('Backend needs to allow this origin in CORS config', 'warning');
            }
        });

        document.getElementById('clearResults').addEventListener('click', () => {
            resultsDiv.innerHTML = '';
        });

        // Auto-run basic test
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('testBasic').click();
            }, 500);
        });
    </script>
</body>
</html>
