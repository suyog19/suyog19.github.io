<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP + Payment Integration Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #3399cc;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #3399cc;
            background: #f8f9fa;
        }
        .step h3 {
            margin: 0 0 10px 0;
            color: #3399cc;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3399cc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ OTP + Payment Integration Demo</h1>
        <p>Complete payment flow with OTP verification using Razorpay + MSG91</p>

        <!-- Step 1: User Details -->
        <div class="step">
            <h3>Step 1: Enter Details</h3>
            <div class="form-group">
                <label for="customerName">Customer Name:</label>
                <input type="text" id="customerName" placeholder="Enter your name" value="John Doe">
            </div>
            <div class="form-group">
                <label for="customerPhone">Phone Number:</label>
                <input type="tel" id="customerPhone" placeholder="Enter 10-digit phone number" value="9819667620">
            </div>
            <div class="form-group">
                <label for="customerEmail">Email:</label>
                <input type="email" id="customerEmail" placeholder="Enter your email" value="john@example.com">
            </div>
            <div class="form-group">
                <label for="amount">Amount (‚Çπ):</label>
                <select id="amount">
                    <option value="1">‚Çπ1 - Test Payment</option>
                    <option value="10">‚Çπ10 - Small Payment</option>
                    <option value="100">‚Çπ100 - Medium Payment</option>
                    <option value="500">‚Çπ500 - Large Payment</option>
                </select>
            </div>
        </div>

        <!-- Step 2: Create Order -->
        <div class="step">
            <h3>Step 2: Create Payment Order</h3>
            <button id="createOrderBtn" onclick="createOrder()">Create Razorpay Order</button>
            <div class="loading" id="orderLoading">
                <div class="spinner"></div>
                <p>Creating order...</p>
            </div>
        </div>

        <!-- Step 3: Make Payment -->
        <div class="step">
            <h3>Step 3: Complete Payment</h3>
            <button id="payBtn" onclick="openRazorpay()" disabled>Pay Now</button>
            <div class="info">
                <strong>Note:</strong> This will open Razorpay payment gateway. Use test card details for testing.
            </div>
        </div>

        <!-- Step 4: OTP Verification -->
        <div class="step">
            <h3>Step 4: OTP Verification</h3>
            <div id="otpSection" style="display: none;">
                <p>OTP has been sent to your phone number!</p>
                <div class="form-group">
                    <label for="otpInput">Enter OTP:</label>
                    <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6">
                </div>
                <button onclick="verifyOTP()">Verify OTP</button>
            </div>
        </div>

        <!-- Messages -->
        <div id="successMsg" class="success"></div>
        <div id="errorMsg" class="error"></div>

        <!-- Debug Info -->
        <div class="step">
            <h3>üîç Debug Information</h3>
            <div id="debugInfo" style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                Waiting for actions...
            </div>
        </div>
    </div>

    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        // Global variables
        let currentOrder = null;
        let generatedOTP = null;
        
        // Configuration - In production, get these from your server
        const CONFIG = {
            RAZORPAY_KEY_ID: 'rzp_test_FxTSJ2PpEdW53N', // Your test key
            SERVER_URL: 'http://localhost:5000' // Your Flask server URL
        };

        // Utility functions
        function showSuccess(message) {
            const successDiv = document.getElementById('successMsg');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMsg').style.display = 'none';
        }

        function updateDebug(info) {
            document.getElementById('debugInfo').innerHTML = `
                <strong>Latest Action:</strong> ${new Date().toLocaleTimeString()}<br>
                ${info}
            `;
        }

        function setLoading(elementId, isLoading) {
            document.getElementById(elementId).style.display = isLoading ? 'block' : 'none';
        }

        // Step 1: Create Razorpay Order
        async function createOrder() {
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const email = document.getElementById('customerEmail').value;
            const amount = document.getElementById('amount').value;

            // Validation
            if (!name || !phone || !email || !amount) {
                showError('Please fill all required fields');
                return;
            }

            if (phone.length !== 10) {
                showError('Please enter a valid 10-digit phone number');
                return;
            }

            setLoading('orderLoading', true);
            document.getElementById('createOrderBtn').disabled = true;

            try {
                // In a real app, this would be an API call to your server
                // For demo, we'll simulate the order creation
                const orderData = await simulateOrderCreation(amount, name, phone, email);
                
                currentOrder = orderData;
                
                // Enable payment button
                document.getElementById('payBtn').disabled = false;
                
                showSuccess(`Order created successfully! Order ID: ${orderData.id}`);
                updateDebug(`
                    <strong>Order Created:</strong><br>
                    Order ID: ${orderData.id}<br>
                    Amount: ‚Çπ${orderData.amount / 100}<br>
                    Customer: ${name}<br>
                    Phone: ${phone}
                `);

            } catch (error) {
                showError('Failed to create order: ' + error.message);
                updateDebug(`<strong>Error:</strong> ${error.message}`);
            } finally {
                setLoading('orderLoading', false);
                document.getElementById('createOrderBtn').disabled = false;
            }
        }

        // Simulate order creation (In real app, call your Python backend)
        async function simulateOrderCreation(amount, name, phone, email) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Simulate order response from your Python backend
            return {
                id: 'order_' + Date.now(),
                amount: parseInt(amount) * 100, // Convert to paise
                currency: 'INR',
                receipt: 'receipt_' + Date.now(),
                status: 'created',
                customer: { name, phone, email }
            };
        }

        // Step 2: Open Razorpay Payment Gateway
        function openRazorpay() {
            if (!currentOrder) {
                showError('Please create an order first');
                return;
            }

            const options = {
                key: CONFIG.RAZORPAY_KEY_ID,
                amount: currentOrder.amount,
                currency: currentOrder.currency,
                name: 'OTP Payment Demo',
                description: 'Test payment with OTP verification',
                order_id: currentOrder.id,
                
                // üéØ PRIMARY METHOD: Handler Function
                handler: function (response) {
                    console.log('Payment successful:', response);
                    
                    // ‚úÖ IMMEDIATE: Send OTP right after payment success
                    handlePaymentSuccess(response);
                },
                
                // Customer prefill
                prefill: {
                    name: currentOrder.customer.name,
                    email: currentOrder.customer.email,
                    contact: currentOrder.customer.phone
                },
                
                // Payment methods
                method: {
                    upi: true,
                    card: true,
                    netbanking: true,
                    wallet: true
                },
                
                // Theme
                theme: {
                    color: '#3399cc'
                },
                
                // Modal settings
                modal: {
                    ondismiss: function() {
                        showError('Payment cancelled by user');
                        updateDebug('<strong>Payment Status:</strong> Cancelled by user');
                    }
                },
                
                // Error handler
                error: function(error) {
                    console.error('Payment error:', error);
                    showError('Payment failed: ' + error.description);
                    updateDebug(`<strong>Payment Error:</strong> ${error.description}`);
                }
            };

            // Open Razorpay checkout
            const rzp = new Razorpay(options);
            rzp.open();
        }

        // Handle successful payment
        async function handlePaymentSuccess(response) {
            try {
                updateDebug(`
                    <strong>Payment Successful!</strong><br>
                    Payment ID: ${response.razorpay_payment_id}<br>
                    Order ID: ${response.razorpay_order_id}<br>
                    Signature: ${response.razorpay_signature?.substring(0, 20)}...
                `);

                showSuccess('Payment successful! Sending OTP...');

                // üöÄ IMMEDIATE ACTION: Send OTP
                await sendOTP(currentOrder.customer.phone);

                // ‚úÖ VERIFICATION: Verify payment on server (in real app)
                await verifyPaymentOnServer(response);

                // Show OTP verification section
                document.getElementById('otpSection').style.display = 'block';
                
                showSuccess('Payment completed! Please verify the OTP sent to your phone.');

            } catch (error) {
                showError('Post-payment processing failed: ' + error.message);
                updateDebug(`<strong>Post-payment Error:</strong> ${error.message}`);
            }
        }

        // Send OTP after successful payment
        async function sendOTP(phoneNumber) {
            try {
                // Generate OTP (In real app, this would be done on server)
                generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
                
                // Simulate sending OTP via MSG91
                // In real app, call your Python backend to send OTP
                console.log(`Sending OTP ${generatedOTP} to ${phoneNumber}`);
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateDebug(`
                    <strong>OTP Sent!</strong><br>
                    Phone: ${phoneNumber}<br>
                    OTP: ${generatedOTP} (For testing only)<br>
                    Method: MSG91 SMS
                `);

                return true;
            } catch (error) {
                throw new Error('Failed to send OTP: ' + error.message);
            }
        }

        // Verify payment on server (backup method)
        async function verifyPaymentOnServer(response) {
            try {
                // In real app, send payment details to your server for verification
                console.log('Verifying payment on server:', response);
                
                // Simulate server verification
                await new Promise(resolve => setTimeout(resolve, 300));
                
                return true;
            } catch (error) {
                throw new Error('Server verification failed');
            }
        }

        // Step 3: Verify OTP
        async function verifyOTP() {
            const enteredOTP = document.getElementById('otpInput').value;
            
            if (!enteredOTP) {
                showError('Please enter the OTP');
                return;
            }

            if (enteredOTP.length !== 6) {
                showError('Please enter a valid 6-digit OTP');
                return;
            }

            try {
                // Verify OTP (In real app, verify on server)
                if (enteredOTP === generatedOTP) {
                    showSuccess('üéâ Complete Success! Payment verified and OTP confirmed!');
                    updateDebug(`
                        <strong>‚úÖ FLOW COMPLETED SUCCESSFULLY!</strong><br>
                        ‚úì Order Created<br>
                        ‚úì Payment Completed<br>
                        ‚úì OTP Verified<br>
                        ‚úì Transaction Complete
                    `);
                    
                    // Hide OTP section
                    document.getElementById('otpSection').style.display = 'none';
                    
                } else {
                    showError('Invalid OTP. Please try again.');
                    updateDebug(`<strong>OTP Verification Failed:</strong> Entered: ${enteredOTP}, Expected: ${generatedOTP}`);
                }
            } catch (error) {
                showError('OTP verification failed: ' + error.message);
            }
        }

        // Initialize page
        window.onload = function() {
            updateDebug('Page loaded. Ready to start payment flow.');
            console.log('OTP + Payment Demo initialized');
        };
    </script>
</body>
</html>
