<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç OTP Test & API Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>üîç SuvicharSathi API Test Dashboard</h2>
        
        <div class="alert alert-success">
            <strong>‚úÖ API Integration Fixed!</strong> All endpoints now match Swagger specification.
        </div>
        
        <div class="row">
            <!-- OTP Testing -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üîê OTP Testing</h5>
                    </div>
                    <div class="card-body">
                        <button id="getLatestOTP" class="btn btn-primary mb-2 w-100">üîç Get Latest Test OTP</button>
                        <button id="sendTestOTP" class="btn btn-success mb-2 w-100">üì± Send Test OTP</button>
                        <div id="otpResults" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>üìä API Endpoint Tests</h5>
                    </div>
                    <div class="card-body">
                        <button id="testAllEndpoints" class="btn btn-info w-100">üß™ Test All Fixed Endpoints</button>
                        <div id="endpointResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã Test Results</h5>
                        <button id="clearResults" class="btn btn-sm btn-outline-secondary float-end">Clear</button>
                    </div>
                    <div class="card-body">
                        <div id="results" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85em; background: #f8f9fa; padding: 10px; border-radius: 5px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Status -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>‚úÖ Fixed API Integrations</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>‚úÖ Authentication APIs (Fixed):</h6>
                                <ul class="list-unstyled">
                                    <li>‚úÖ <code>/auth/register/send-otp</code> - Fixed: <code>name</code> field</li>
                                    <li>‚úÖ <code>/auth/register/verify-otp</code> - Fixed: <code>otp_code</code> field</li>
                                    <li>‚úÖ <code>/auth/login/verify-otp</code> - Fixed: <code>otp_code</code> field</li>
                                    <li>‚úÖ <code>/auth/resend-otp</code> - Fixed: Single endpoint</li>
                                    <li>üÜï <code>/auth/test-otp</code> - Added for development</li>
                                    <li>üÜï <code>/auth/me</code> - Added for user profile</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>‚úÖ Payment APIs (Fixed):</h6>
                                <ul class="list-unstyled">
                                    <li>‚úÖ <code>/payments/initiate</code> - Fixed: <code>plan_id</code> field</li>
                                    <li>‚úÖ <code>/payments/verify</code> - Fixed: Razorpay field names</li>
                                    <li>üÜï <code>/payments/plans</code> - Added for subscription plans</li>
                                    <li>‚úÖ <code>/payments/history</code> - Already correct</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/api.js"></script>
    <script>
        const api = new APIService();
        const resultsDiv = document.getElementById('results');
        const otpResultsDiv = document.getElementById('otpResults');
        const endpointResultsDiv = document.getElementById('endpointResults');

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const colors = {
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            
            const div = document.createElement('div');
            div.style.color = colors[type] || '#000';
            div.style.marginBottom = '3px';
            div.innerHTML = `<strong>[${time}]</strong> ${message}`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function logToSection(sectionDiv, message, type = 'info') {
            const colors = {
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning',
                'info': 'text-info'
            };
            
            const div = document.createElement('div');
            div.className = `${colors[type]} mb-1`;
            div.innerHTML = message;
            sectionDiv.appendChild(div);
        }

        // Get Latest OTP
        document.getElementById('getLatestOTP').addEventListener('click', async () => {
            otpResultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Getting latest OTP...';
            log('üîç Fetching latest test OTP...', 'info');
            
            try {
                const result = await api.getTestOTP();
                
                if (result.success) {
                    log(`‚úÖ Latest OTP retrieved: ${JSON.stringify(result.data)}`, 'success');
                    otpResultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>üéØ Latest Test OTP:</h6>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    log(`‚ùå Failed to get OTP: ${result.error}`, 'error');
                    otpResultsDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                otpResultsDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
            }
        });

        // Send Test OTP
        document.getElementById('sendTestOTP').addEventListener('click', async () => {
            const testPhone = '9999999999';
            const testName = 'Test User';
            
            otpResultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Sending test OTP...';
            log('üì± Sending test OTP to 9999999999...', 'info');
            
            try {
                const result = await api.sendRegistrationOTP(testPhone, testName, 'test@example.com');
                
                if (result.success) {
                    log(`‚úÖ OTP sent successfully: ${JSON.stringify(result.data)}`, 'success');
                    otpResultsDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>üì± OTP Sent Successfully!</h6>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                            <small class="text-muted">Now click "Get Latest Test OTP" to see the generated OTP</small>
                        </div>
                    `;
                } else {
                    log(`‚ùå Failed to send OTP: ${result.error}`, 'error');
                    otpResultsDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${result.error}</div>`;
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                otpResultsDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
            }
        });

        // Test All Endpoints
        document.getElementById('testAllEndpoints').addEventListener('click', async () => {
            endpointResultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing all endpoints...';
            log('üß™ Testing all fixed API endpoints...', 'info');
            
            const tests = [
                { name: 'GET /auth/test-otp', test: () => api.getTestOTP() },
                { name: 'GET /payments/plans', test: () => api.getPaymentPlans() },
                { name: 'POST /auth/register/send-otp', test: () => api.sendRegistrationOTP('9999999999', 'Test User') },
            ];
            
            endpointResultsDiv.innerHTML = '';
            
            for (const testCase of tests) {
                logToSection(endpointResultsDiv, `Testing: ${testCase.name}...`, 'info');
                
                try {
                    const result = await testCase.test();
                    if (result.success) {
                        logToSection(endpointResultsDiv, `‚úÖ ${testCase.name}: SUCCESS`, 'success');
                        log(`‚úÖ ${testCase.name}: SUCCESS`, 'success');
                    } else {
                        logToSection(endpointResultsDiv, `‚ö†Ô∏è ${testCase.name}: ${result.error}`, 'warning');
                        log(`‚ö†Ô∏è ${testCase.name}: ${result.error}`, 'warning');
                    }
                } catch (error) {
                    logToSection(endpointResultsDiv, `‚ùå ${testCase.name}: ${error.message}`, 'error');
                    log(`‚ùå ${testCase.name}: ${error.message}`, 'error');
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            logToSection(endpointResultsDiv, 'üèÅ All endpoint tests completed!', 'success');
        });

        document.getElementById('clearResults').addEventListener('click', () => {
            resultsDiv.innerHTML = '';
            otpResultsDiv.innerHTML = '';
            endpointResultsDiv.innerHTML = '';
        });
    </script>
</body>
</html>
